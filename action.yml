name: Build and test with ghcr.io/kxcinc/ocaml-general
description: Build and test OCaml projects using the ghcr.io/kxcinc/ocaml-general docker container
author: KXC Members and Contributors
branding:
  icon: sunrise
  color: orange
inputs:

  build-command:
    description: "Override the default build command"
    required: false
    default: ""

  test-command:
    description: "Override the default test command"
    required: false
    default: ""
  skip-testing:
    description: "Whether or not to skip running the tests"
    required: false
    default: false

  setup-command:
    description: "Override the default setup command"
    required: false
    default: "opam install . --yes --deps-only --with-test --verbose"
  skip-setup:
    description: "Whether or not to skip running setups"
    required: false
    default: false

  with-odoc:
    description: "Build odoc documents"
    required: false
    default: false
  odoc-build-command:
    description: "Override the default odoc build command"
    required: false
    default: "opam exec -- dune build @doc"
  odoc-upload-artifact:
    required: false
    default: true
  odoc-upload-artifact-name:
    required: false
    default: "github-pages"
  odoc-deploy-github-pages:
    required: false
    description: "NOT YET SUPPORTED due to actions/runner#2009"
    default: false

outputs:
  odoc-site-path:
    description: |
      !!(DUE TO actions/runner#2009, THIS IS OUTPUT IS NOT AVAILABLE)
      Path to odoc document site build result, if with-odoc is set to true
  odoc-github-pages-url:
    description: |
      !!(DUE TO actions/runner#2009, THIS IS OUTPUT IS NOT AVAILABLE)
      URL to deployed GitHub Pages by odoc

runs:
  using: composite
  steps:
    - run: echo "action_path is " "${{ github.action_path }}"
      shell: bash
    - run: find "${{ github.action_path }}"
      shell: bash
    - run: find "${{ github.action_path }}/.."
      shell: bash
    - run: echo "pwd is $(pwd)"
      shell: bash

    - name: Build and test with OCaml
      id: internals_ocaml-general-gha-bare
      # uses: kxcdev/ocaml-general-gha-bare@78ec6ee277e0ee5c0185e8f083cf51cb65cae5e4
      uses: "${{ github.action_path }}/sub-actions/v2-original"
      with:
        build-command: "${{ inputs.build-command }}"
        test-command: "${{ inputs.test-command }}"
        skip-testing: "${{ inputs.skip-testing }}"
        setup-command: "${{ inputs.setup-command }}"
        skip-setup: "${{ inputs.skip-setup }}"
        with-odoc: "${{ inputs.with-odoc }}"
        odoc-build-command: "${{ inputs.odoc-build-command }}"

    - name: Upload artifact
      if: ${{ inputs.with-odoc == 'true' && inputs.odoc-upload-artifact == 'true' }}
      uses: actions/upload-pages-artifact@v2
      with:
        path: ${{ steps.internals_ocaml-general-gha-bare.outputs.odoc-site-path }}
        name: ${{ inputs.odoc-upload-artifact-name }}

    ## won't work because of actions/runner#2009
    - run: echo "odoc-site-path=${{ steps.internals_ocaml-general-gha-bare.outputs.odoc-site-path }}" >> $GITHUB_OUTPUT
      shell: bash
      id: internals_ocaml-general-gha-odoc-site-path
      if: ${{ inputs.with-odoc == 'true' }}

    - run: |
        echo "odoc-deploy-github-pages not yet supported, pending actions/runner#2009"
        false
      shell: bash
      if: ${{ inputs.odoc-deploy-github-pages == 'true' }}

    ## waiting for the resolution of actions/runner#2009

    # - name: Setup Pages
    #   if: ${{ inputs.odoc-deploy-github-pages }}
    #   uses: actions/configure-pages@v3

    # - name: Deploy to GitHub Pages
    #   if: ${{ inputs.odoc-deploy-github-pages }}
    #   id: internals_ocaml-general-gha-deployment
    #   uses: actions/deploy-pages@v2

    ## won't work because of actions/runner#2009
    # - run: echo "odoc-github-pages-url=${{ steps.internals_ocaml-general-gha-deployment.outputs.page_url }}" >> $GITHUB_OUTPUT
    #   shell: bash
    #   id: internals_ocaml-general-gha-odoc-ghp-url
    #   if: ${{ inputs.odoc-deploy-github-pages }}
